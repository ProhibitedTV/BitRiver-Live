version: "3.9"

services:
  bitriver-live:
    build:
      context: ..
      dockerfile: Dockerfile
    image: bitriver-live:latest
    container_name: bitriver-live
    env_file:
      - ../.env
    ports:
      - "${BITRIVER_LIVE_PORT:-8080}:8080"
    environment:
      BITRIVER_LIVE_STORAGE_DRIVER: ${BITRIVER_LIVE_STORAGE_DRIVER:-postgres}
      BITRIVER_LIVE_MODE: ${BITRIVER_LIVE_MODE:-production}
      BITRIVER_LIVE_ADDR: ${BITRIVER_LIVE_ADDR:-:8080}
      BITRIVER_LIVE_POSTGRES_DSN: ${BITRIVER_LIVE_POSTGRES_DSN:-postgres://bitriver:bitriver@postgres:5432/bitriver?sslmode=disable}
      BITRIVER_LIVE_POSTGRES_MAX_CONNS: ${BITRIVER_LIVE_POSTGRES_MAX_CONNS:-15}
      BITRIVER_LIVE_POSTGRES_MIN_CONNS: ${BITRIVER_LIVE_POSTGRES_MIN_CONNS:-5}
      BITRIVER_LIVE_POSTGRES_ACQUIRE_TIMEOUT: ${BITRIVER_LIVE_POSTGRES_ACQUIRE_TIMEOUT:-5s}
      BITRIVER_LIVE_POSTGRES_MAX_CONN_LIFETIME: ${BITRIVER_LIVE_POSTGRES_MAX_CONN_LIFETIME:-30m}
      BITRIVER_VIEWER_ORIGIN: ${BITRIVER_VIEWER_ORIGIN:-http://viewer:3000}
      BITRIVER_SRS_API: ${BITRIVER_SRS_API:-http://srs:1985}
      BITRIVER_SRS_TOKEN: ${BITRIVER_SRS_TOKEN:-local-dev-token}
      BITRIVER_OME_API: ${BITRIVER_OME_API:-http://ome:8081}
      BITRIVER_OME_USERNAME: ${BITRIVER_OME_USERNAME:-admin}
      BITRIVER_OME_PASSWORD: ${BITRIVER_OME_PASSWORD:-local-dev-password}
      BITRIVER_TRANSCODER_API: ${BITRIVER_TRANSCODER_API:-http://transcoder:9000}
      BITRIVER_TRANSCODER_TOKEN: ${BITRIVER_TRANSCODER_TOKEN:-local-dev-token}
      BITRIVER_INGEST_HEALTH: ${BITRIVER_INGEST_HEALTH:-/healthz}
      BITRIVER_LIVE_ADMIN_EMAIL: ${BITRIVER_LIVE_ADMIN_EMAIL:-admin@example.com}
      BITRIVER_LIVE_ADMIN_PASSWORD: ${BITRIVER_LIVE_ADMIN_PASSWORD:-change-me-now}
      # Enable HTTPS by mounting certs and uncommenting the lines below.
      # BITRIVER_LIVE_TLS_CERT: /certs/fullchain.pem
      # BITRIVER_LIVE_TLS_KEY: /certs/privkey.pem
      # Tune rate limiting and shared state.
      # BITRIVER_LIVE_RATE_GLOBAL_RPS: "50"
      # BITRIVER_LIVE_RATE_GLOBAL_BURST: "100"
      # BITRIVER_LIVE_RATE_LOGIN_LIMIT: "5"
      # BITRIVER_LIVE_RATE_LOGIN_WINDOW: 2m
      # BITRIVER_LIVE_RATE_REDIS_ADDR: redis:6379
      # BITRIVER_LIVE_RATE_REDIS_PASSWORD: supersecret
    volumes:
      - ./data:/var/lib/bitriver-live
      # - ./certs:/certs
    command: ["/app/bitriver-live"]
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      - postgres
      - srs
      - ome
      - transcoder

  viewer:
    build:
      context: ../web/viewer
    image: bitriver-viewer:latest
    container_name: bitriver-viewer
    env_file:
      - ../.env
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-""}
      NEXT_VIEWER_BASE_PATH: ${NEXT_VIEWER_BASE_PATH:-/viewer}
      NEXT_PUBLIC_VIEWER_URL: ${NEXT_PUBLIC_VIEWER_URL:-http://localhost:8080/viewer}
      PORT: 3000
      HOSTNAME: 0.0.0.0
    expose:
      - "3000"
    depends_on:
      - bitriver-live

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - redis-data:/data
    ports:
      - "${BITRIVER_REDIS_PORT:-6379}:6379"

  postgres:
    image: postgres:15-alpine
    container_name: bitriver-postgres
    environment:
      POSTGRES_DB: bitriver
      POSTGRES_USER: bitriver
      POSTGRES_PASSWORD: bitriver
    ports:
      - "${BITRIVER_POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bitriver -d bitriver"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  srs:
    image: ossrs/srs:5
    container_name: bitriver-srs
    ports:
      - "${BITRIVER_SRS_RTMP_PORT:-1935}:1935"
      - "${BITRIVER_SRS_API_PORT:-1985}:1985"
    volumes:
      - ./srs/conf:/usr/local/srs/conf
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:1985/healthz || curl -fsS http://localhost:1985/api/v1/versions"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  ome:
    image: airensoft/ovenmediaengine:0.15.10
    container_name: bitriver-ome
    ports:
      - "${BITRIVER_OME_HTTP_PORT:-8081}:8081"
      - "${BITRIVER_OME_SIGNALLING_PORT:-9000}:9000"
    volumes:
      - ./ome/Server.xml:/opt/ovenmediaengine/bin/origin_conf/Server.xml:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8081/healthz || curl -fsS http://localhost:8081/v1/system/monitoring"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  transcoder:
    image: ghcr.io/bitriver-live/ffmpeg-job-controller:latest
    container_name: bitriver-transcoder
    ports:
      - "${BITRIVER_TRANSCODER_HOST_PORT:-9001}:9000"
    environment:
      JOB_CONTROLLER_BIND: :9000
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9000/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  redis-data:
  data:
  postgres-data:
