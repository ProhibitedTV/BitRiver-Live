x-required-credentials: &required_credentials
  # Populate these credentials in ../.env before starting the stack.
  BITRIVER_LIVE_ADMIN_EMAIL: ${BITRIVER_LIVE_ADMIN_EMAIL:?set via .env}
  BITRIVER_LIVE_ADMIN_PASSWORD: ${BITRIVER_LIVE_ADMIN_PASSWORD:?set via .env}
  BITRIVER_SRS_TOKEN: ${BITRIVER_SRS_TOKEN:?set via .env}
  BITRIVER_OME_USERNAME: ${BITRIVER_OME_USERNAME:?set via .env}
  BITRIVER_OME_PASSWORD: ${BITRIVER_OME_PASSWORD:?set via .env}
  BITRIVER_TRANSCODER_TOKEN: ${BITRIVER_TRANSCODER_TOKEN:?set via .env}
  BITRIVER_REDIS_PASSWORD: ${BITRIVER_REDIS_PASSWORD:?set via .env}
  BITRIVER_LIVE_CHAT_QUEUE_REDIS_PASSWORD: ${BITRIVER_LIVE_CHAT_QUEUE_REDIS_PASSWORD:?set via .env}

services:
  bitriver-live:
    image: ghcr.io/bitriver-live/bitriver-live:${BITRIVER_LIVE_IMAGE_TAG:?set via .env}
    # Uncomment the block below to build the API image locally instead of pulling from GHCR.
    # build:
    #   context: ..
    #   dockerfile: Dockerfile
    container_name: bitriver-live
    restart: unless-stopped
    env_file:
      - ../.env
    ports:
      - "${BITRIVER_LIVE_PORT:-8080}:8080"
    environment:
      <<: *required_credentials
      BITRIVER_LIVE_STORAGE_DRIVER: ${BITRIVER_LIVE_STORAGE_DRIVER:-postgres}
      BITRIVER_LIVE_SESSION_STORE: ${BITRIVER_LIVE_SESSION_STORE:-postgres}
      BITRIVER_LIVE_MODE: ${BITRIVER_LIVE_MODE:-production}
      BITRIVER_LIVE_ADDR: ${BITRIVER_LIVE_ADDR:-:8080}
      BITRIVER_LIVE_POSTGRES_DSN: ${BITRIVER_LIVE_POSTGRES_DSN:-postgres://${BITRIVER_POSTGRES_USER:?set via .env}:${BITRIVER_POSTGRES_PASSWORD:?set via .env}@postgres:5432/${BITRIVER_POSTGRES_DB:-bitriver}?sslmode=disable}
      # Sessions reuse BITRIVER_LIVE_POSTGRES_DSN when BITRIVER_LIVE_SESSION_POSTGRES_DSN is unset.
      BITRIVER_LIVE_POSTGRES_MAX_CONNS: ${BITRIVER_LIVE_POSTGRES_MAX_CONNS:-15}
      BITRIVER_LIVE_POSTGRES_MIN_CONNS: ${BITRIVER_LIVE_POSTGRES_MIN_CONNS:-5}
      BITRIVER_LIVE_POSTGRES_ACQUIRE_TIMEOUT: ${BITRIVER_LIVE_POSTGRES_ACQUIRE_TIMEOUT:-5s}
      BITRIVER_LIVE_POSTGRES_MAX_CONN_LIFETIME: ${BITRIVER_LIVE_POSTGRES_MAX_CONN_LIFETIME:-30m}
      BITRIVER_VIEWER_ORIGIN: ${BITRIVER_VIEWER_ORIGIN:-http://viewer:3000}
      BITRIVER_SRS_API: ${BITRIVER_SRS_API:-http://srs-controller:1985}
      BITRIVER_OME_API: ${BITRIVER_OME_API:-http://ome:8081}
      BITRIVER_TRANSCODER_API: ${BITRIVER_TRANSCODER_API:-http://transcoder:9000}
      BITRIVER_INGEST_HEALTH: ${BITRIVER_INGEST_HEALTH:-/healthz}
      BITRIVER_LIVE_CHAT_QUEUE_DRIVER: ${BITRIVER_LIVE_CHAT_QUEUE_DRIVER:-redis}
      BITRIVER_LIVE_CHAT_QUEUE_REDIS_ADDR: ${BITRIVER_LIVE_CHAT_QUEUE_REDIS_ADDR:-redis:6379}
      BITRIVER_LIVE_CHAT_QUEUE_REDIS_PASSWORD: ${BITRIVER_LIVE_CHAT_QUEUE_REDIS_PASSWORD:?set via .env}
      BITRIVER_LIVE_CHAT_QUEUE_REDIS_STREAM: ${BITRIVER_LIVE_CHAT_QUEUE_REDIS_STREAM:-bitriver-live-chat}
      BITRIVER_LIVE_CHAT_QUEUE_REDIS_GROUP: ${BITRIVER_LIVE_CHAT_QUEUE_REDIS_GROUP:-bitriver-live-api}
      # Enable HTTPS by mounting certs and uncommenting the lines below.
      # BITRIVER_LIVE_TLS_CERT: /certs/fullchain.pem
      # BITRIVER_LIVE_TLS_KEY: /certs/privkey.pem
      # Tune rate limiting and shared state.
      # BITRIVER_LIVE_RATE_GLOBAL_RPS: "50"
      # BITRIVER_LIVE_RATE_GLOBAL_BURST: "100"
      # BITRIVER_LIVE_RATE_LOGIN_LIMIT: "5"
      # BITRIVER_LIVE_RATE_LOGIN_WINDOW: 2m
      # BITRIVER_LIVE_RATE_REDIS_ADDR: redis:6379
      # BITRIVER_LIVE_RATE_REDIS_PASSWORD: supersecret
    volumes:
      - ./data:/var/lib/bitriver-live
      # - ./certs:/certs
    command: ["/app/bitriver-live"]
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      - postgres
      - srs-controller
      - ome
      - transcoder

  viewer:
    image: ghcr.io/bitriver-live/bitriver-viewer:${BITRIVER_VIEWER_IMAGE_TAG:?set via .env}
    # Uncomment the block below to build the viewer image locally instead of pulling from GHCR.
    # build:
    #   context: ../web/viewer
    container_name: bitriver-viewer
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-""}
      NEXT_VIEWER_BASE_PATH: ${NEXT_VIEWER_BASE_PATH:-/viewer}
      NEXT_PUBLIC_VIEWER_URL: ${NEXT_PUBLIC_VIEWER_URL:-http://localhost:8080/viewer}
      PORT: 3000
      HOSTNAME: 0.0.0.0
    expose:
      - "3000"
    depends_on:
      - bitriver-live

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: [
      "redis-server",
      "--save", "", "--appendonly", "no",
      "--requirepass", "${BITRIVER_REDIS_PASSWORD:?set via .env}"
    ]
    volumes:
      - redis-data:/data

  postgres:
    image: postgres:15-alpine
    container_name: bitriver-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${BITRIVER_POSTGRES_DB:-bitriver}
      POSTGRES_USER: ${BITRIVER_POSTGRES_USER:?set via .env}
      POSTGRES_PASSWORD: ${BITRIVER_POSTGRES_PASSWORD:?set via .env}
    ports:
      - "${BITRIVER_POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./migrations:/migrations:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$$POSTGRES_USER\" -d \"$$POSTGRES_DB\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  srs-controller:
    image: ghcr.io/bitriver-live/bitriver-srs-controller:${BITRIVER_SRS_CONTROLLER_IMAGE_TAG:?set via .env}
    container_name: bitriver-srs-controller
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      BITRIVER_SRS_TOKEN: ${BITRIVER_SRS_TOKEN:?set via .env}
      SRS_CONTROLLER_BIND: :1985
      SRS_CONTROLLER_UPSTREAM: ${SRS_CONTROLLER_UPSTREAM:-http://srs:1985/api/}
    ports:
      - "${BITRIVER_SRS_CONTROLLER_PORT:-1986}:1985"
    depends_on:
      - srs
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:1985/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  srs:
    image: ossrs/srs:${BITRIVER_SRS_IMAGE_TAG:-v5.0.185}
    container_name: bitriver-srs
    restart: unless-stopped
    ports:
      - "${BITRIVER_SRS_RTMP_PORT:-1935}:1935"
      - "${BITRIVER_SRS_API_PORT:-1985}:1985"
    volumes:
      - ./srs/conf:/usr/local/srs/conf
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:1985/healthz || curl -fsS http://localhost:1985/api/v1/versions"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  ome:
    image: airensoft/ovenmediaengine:0.15.10
    container_name: bitriver-ome
    restart: unless-stopped
    ports:
      - "${BITRIVER_OME_HTTP_PORT:-8081}:8081"
      - "${BITRIVER_OME_SIGNALLING_PORT:-9000}:9000"
    volumes:
      - ./ome/Server.xml:/opt/ovenmediaengine/bin/origin_conf/Server.xml:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8081/healthz || curl -fsS http://localhost:8081/v1/system/monitoring"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  transcoder:
    image: ghcr.io/bitriver-live/bitriver-transcoder:${BITRIVER_TRANSCODER_IMAGE_TAG:?set via .env}
    # Uncomment the block below to build the transcoder image locally instead of pulling from GHCR.
    # build:
    #   context: ..
    #   dockerfile: cmd/transcoder/Dockerfile
    container_name: bitriver-transcoder
    restart: unless-stopped
    ports:
      - "${BITRIVER_TRANSCODER_HOST_PORT:-9001}:9000"
    environment:
      JOB_CONTROLLER_BIND: :9000
      JOB_CONTROLLER_TOKEN: ${BITRIVER_TRANSCODER_TOKEN:?set via .env}
      BITRIVER_TRANSCODER_PUBLIC_BASE_URL: ${BITRIVER_TRANSCODER_PUBLIC_BASE_URL:?set via .env}
      BITRIVER_TRANSCODER_PUBLIC_DIR: ${BITRIVER_TRANSCODER_PUBLIC_DIR:-/work/public}
    volumes:
      - ./transcoder-data:/work
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9000/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  transcoder-public:
    image: nginx:alpine
    container_name: bitriver-transcoder-public
    depends_on:
      - transcoder
    restart: unless-stopped
    ports:
      - "${BITRIVER_TRANSCODER_PUBLIC_PORT:-9080}:8080"
    volumes:
      - ./transcoder-data:/work:ro
      - ./nginx/transcoder-public.conf:/etc/nginx/nginx.conf:ro

volumes:
  redis-data:
  data:
  postgres-data:
